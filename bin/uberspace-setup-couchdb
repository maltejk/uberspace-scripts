#!/bin/sh
########################################################################
# 2014-07-29 Moritz Werner mwerner@jonaspasche.com
########################################################################
#
#	This program is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
########################################################################
#
# This script will setup a CouchDB installation for a user
#
########################################################################

MY_UID=`id -u`

if [ "$MY_UID" = "0" ] ; then
  echo "This script is not designed to run as root."
  exit 1
fi

if [ ! -d ~/service ] ; then
  echo "You need to have a working ~/service directory first to run your own daemons."
  echo "Please run \"uberspace-setup-svscan\" to initialize it before setting up CouchDB."
  exit 2
fi

for DIR in ~/couchdb ~/service/couchdb ~/etc/run-couchdb ; do
  if [ -d $DIR ] ; then
    echo "You already have a $DIR directory. Nothing to do here."
    exit 3
  fi
done

# create the database directory
echo "Creating the ~/couchdb database directory"
mkdir ~/couchdb

# choose a unique (!) port number
COUCHDB_PORT=$((21000 + $MY_UID))
COUCHDB_USER="`id -un`_couchadmin"
COUCHDB_PASS=`apg -n 1`

# create couchdb.ini
cat <<__EOF__ > ~/couchdb.ini
[couchdb]
database_dir = /home/$USER/couchdb
view_index_dir = /home/$USER/couchdb
uri_file = /home/$USER/couchdb/couch.uri

[log]
file = /home/$USER/couchdb/couch.log

[httpd]
port = $COUCHDB_PORT

[admins]
$COUCHDB_USER = $COUCHDB_PASS

[couch_httpd_auth]
require_valid_user = true
__EOF__

# create the couchdb service run script
echo "Creating the ~/etc/run-couchdb/run service run script"
mkdir ~/etc/run-couchdb
cat <<__EOF__ > ~/etc/run-couchdb/run
#!/bin/sh
export HOME=$HOME
export COUCHPATH="/package/host/localhost/couchdb-1.5/"

exec \$COUCHPATH/bin/couchdb -n -a \$COUCHPATH/etc/couchdb/default.ini -a $HOME/couchdb.ini 2>&1
__EOF__
chmod 755 ~/etc/run-couchdb/run

# create the couchdb logging run script
echo "Creating the ~/etc/run-couchdb/log/run logging run script"
mkdir ~/etc/run-couchdb/log
cat <<__EOF__ > ~/etc/run-couchdb/log/run
#!/bin/sh
exec multilog t ./main
__EOF__
chmod 755 ~/etc/run-couchdb/log/run

echo "Symlinking ~/etc/run-couchdb to ~/service/couchdb to start the service"
ln -s ../etc/run-couchdb ~/service/couchdb

WAIT=0
echo -n "Waiting for the service to start ..."
while [ $WAIT -lt 6 ]; do
  WAIT=$(($WAIT+1))
  echo -n " $WAIT"
  svok ~/service/couchdb 2>/dev/null
  SVOK=$?
  if [ "$SVOK" = "0" ] ; then
    break
  fi
  sleep 1
done

if [ "$SVOK" != "0" ] ; then
  echo " failed :-("
  echo "We're really sorry; this shouldn't have happened - please contact hallo@uberspace.de for help. Thanks a lot!"
  exit 4
fi

# final information
echo
echo "Congratulations - You can now reach your dedicated CouchDB installation!"
echo "Please note that your CouchDB uses the NON-standard port number $COUCHDB_PORT."
echo
echo "Hostname: localhost"
echo " Portnum: $COUCHDB_PORT"
echo "Username: $COUCHDB_USER"
echo "Password: $COUCHDB_PASS"
echo ""
echo "Settings: $HOME/couchdb.ini"
echo " Logfile: /home/$USER/couchdb/couch.log"
